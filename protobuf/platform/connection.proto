syntax = "proto3";

package platform;

option go_package = "github.com/adarko-io/platform-api/go/v4/platform";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "platform/shared_enums.proto";
import "google/protobuf/struct.proto";

// ConnectionService provides API methods for managing connections for Consumers.
service ConnectionService {
  // Create a new connection for a consumer.
  rpc Create(CreateConnectionRequest) returns (CreateConnectionResponse) {
    option (google.api.http) = {
      post: "/api/connections"
      body: "*"
    };
  } 
  
  // Get the connection details for a given Connection ID.
    rpc Get(GetConnectionRequest) returns (GetConnectionResponse) {
        option (google.api.http) = {
        get: "/api/connections/{id}"
        };
    }

    // Update an existing connection for a consumer.
    rpc Update(UpdateConnectionRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
        put: "/api/connections/{connection.id}"
        body: "*"
        };
    }
    // Delete a connection for a consumer.
    rpc Delete(DeleteConnectionRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
        delete: "/api/connections/{connection_id}"
        };
    }

    // List all connections 
    rpc List(ListConnectionsRequest) returns (ListConnectionsResponse) {
        option (google.api.http) = {
        get: "/api/connections"
        };
    }

    // Add a meter to a connection.
    rpc AddMeterToConnection(AddMeterToConnectionRequest) returns (AddMeterToConnectionResponse) {
        option (google.api.http) = {
        post: "/api/connections/{meter_connection.connection_id}/meters"
        body: "*"
        };
    }
    // Get a meter connection by ID.
    rpc GetMeterConnection(GetMeterConnectionRequest) returns (GetMeterConnectionResponse) {
        option (google.api.http) = {
        get: "/api/connections/{connection_id}/meters/{meter_connection_id}"
        };
    }
    // Remove a meter from a connection.
    rpc RemoveMeterFromConnection(RemoveMeterFromConnectionRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
        delete: "/api/connections/{connection_id}/meters/{meter_connection_id}"
        };
    }
    // Update a meter connection.
    rpc UpdateMeterConnection(UpdateMeterConnectionRequest) returns (google.protobuf.Empty) {
        option (google.api.http) = {
        put: "/api/connections/{meter_connection.connection_id}/meters/{meter_connection.id}"
        body: "*"
        };
    }
    // List all meter connections.
    rpc ListMeterConnections(ListMeterConnectionsRequest) returns (ListMeterConnectionsResponse) {
        option (google.api.http) = {
        get: "/api/connections/{connection_id}/meters"
        };
    }
}



// Connection represents a connection configuration for a consumer.
// ID
// 	ConsumerID (FK → Consumer)
// 	ConnectionType (water/gas/electricity)
// 	ConnectionNumber / ServiceNumber
// 	Category (domestic/commercial/industrial)
// 	Status (active/disconnected/disabled)
// 	CreatedAt
message Connection {
    string id = 1; // Unique identifier for the connection.
    string consumer_id = 2; // ID of the consumer this connection belongs to.
    ConnectionType connection_type = 3; // Type of connection (e.g., water, gas, electricity).
    string connection_number = 4; // Connection or service number.
    ConnectionCategory category = 5; // Category of the connection (e.g., domestic, commercial, industrial).
    ConnectionStatus status = 6; // Status of the connection (e.g., active, disconnected, disabled).
    string tenant_id = 7; // Tenant ID (UUID) to which the connection belongs.
    google.protobuf.Timestamp created_at = 8; // Timestamp when the connection was created.
    google.protobuf.Timestamp updated_at = 9;
}

// Request message for creating a connection.
message CreateConnectionRequest {
    Connection connection = 1;
}

//
message CreateConnectionResponse {
    string id = 1;
}

// Request message for getting a connection by ID.
message GetConnectionRequest {
    string id = 1;
}

// Response message for getting a connection.
message GetConnectionResponse {
    Connection connection = 1;
}

// Request message for updating a connection.
message UpdateConnectionRequest {
    Connection connection = 1;
}

// Request message for deleting a connection by ID.
message DeleteConnectionRequest {
    string connection_id = 1;
}   
// Request message for listing connections.
message ListConnectionsRequest {
    string tenant_id = 1; // Optional tenant ID to filter connections.
    string consumer_id = 2; // Optional consumer ID to filter connections.
    uint32 limit = 3; // Maximum number of connections to return.
    uint32 offset = 4; // Offset for pagination.
    ConnectionStatus status = 5; // Optional status to filter connections.
    ConnectionType connection_type = 6; // Optional connection type to filter connections.
    ConnectionCategory category = 7; // Optional category to filter connections.
}

// Response message for listing connections.
message ListConnectionsResponse {
    uint32 total_count = 1; // Total number of connections matching the criteria.
    repeated Connection connections = 2; // List of connections.
   
}

// Fields
// 	•	ID
// 	•	ConnectionID (FK → Connection)
// 	•	MeterSerial / MeterEUI (link to IoT device)
// 	•	MeterType (pulse/lorawan/wmbus/smart)
// 	•	InstalledAt
// 	•	RemovedAt (nullable)
// 	•	Multiplier / PulseConstant
// 	•	LastKnownReading

message MeterConnection {
    string id = 1; // Unique identifier for the MeterConnection.
    google.protobuf.Timestamp installed_at = 2; // Timestamp when the meter was installed.
    google.protobuf.Timestamp removed_at = 3; // Timestamp when the meter was removed (nullable).
    google.protobuf.Timestamp created_at = 4; // Timestamp when the meter was created.
    google.protobuf.Timestamp updated_at = 5; // Timestamp when the meter was updated.
    string connection_id = 6; // ID of the connection this meter is associated with.
    string meter_eui = 7; // Meter serial number or EUI.
    string meter_serial_number = 8; // Meter serial number or EUI.
    MeterStatus meter_status = 9; // Status of the meter (e.g., active, inactive).
    double last_known_reading = 10; // Last known reading from the meter.
    double first_billable_reading = 11; // First billable reading from the meter.
    
}

// Add Meter to Connection
message AddMeterToConnectionRequest {
    MeterConnection meter_connection = 1;
}

// Response message for adding a meter to a connection.
message AddMeterToConnectionResponse {
    string id = 1;
}

// Get MeterConnection by ID
message GetMeterConnectionRequest {
    string connection_id = 1;
    string meter_connection_id = 2;
}
// Response message for getting a MeterConnection.
message GetMeterConnectionResponse {
    MeterConnection meter_connection = 1;
}

// Remove Meter from Connection
message RemoveMeterFromConnectionRequest {
    string connection_id = 1;
    string meter_connection_id = 2;
}

// Update MeterConnection
message UpdateMeterConnectionRequest {
    MeterConnection meter_connection = 1;
}

// List MeterConnections
message ListMeterConnectionsRequest {
    string connection_id = 1; // Optional connection ID to filter meter connections.
    uint32 limit = 2; // Maximum number of meter connections to return.
    uint32 offset = 3; // Offset for pagination.
    MeterStatus meter_status = 4; // Optional status to filter meter connections.
}

// Response message for listing MeterConnections.
message ListMeterConnectionsResponse {
    uint32 total_count = 1; // Total number of meter connections matching the criteria.
    repeated MeterConnection meter_connections = 2; // List of meter connections.
}
