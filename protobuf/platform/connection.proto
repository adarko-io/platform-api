syntax = "proto3";

package platform;

option go_package = "github.com/adarko-io/platform-api/go/v4/platform";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "platform/shared_enums.proto";
import "google/protobuf/struct.proto";

// ConnectionService provides API methods for managing connections for Consumers.
service ConnectionService {
  // Create a new connection for a consumer.
  rpc Create(CreateConnectionRequest) returns (CreateConnectionResponse) {
    option (google.api.http) = {
      post: "/api/connections"
      body: "*"
    };
  }

  // Get the connection details for a given Connection ID.
  rpc Get(GetConnectionRequest) returns (GetConnectionResponse) {
    option (google.api.http) = {
      get: "/api/connections/{id}"
    };
  }

  // Update an existing connection for a consumer.
  rpc Update(UpdateConnectionRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put: "/api/connections/{connection.id}"
      body: "*"
    };
  }

  // Delete a connection for a consumer.
  rpc Delete(DeleteConnectionRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/connections/{connection_id}"
    };
  }

  // List all connections
  rpc List(ListConnectionsRequest) returns (ListConnectionsResponse) {
    option (google.api.http) = {
      get: "/api/connections"
    };
  }

  // Add a meter to a connection.
  rpc AddMeterToConnection(AddMeterToConnectionRequest) returns (AddMeterToConnectionResponse) {
    option (google.api.http) = {
      post: "/api/connections/{meter_connection.connection_id}/meters"
      body: "*"
    };
  }

  // Get a meter connection by ID.
  rpc GetMeterConnection(GetMeterConnectionRequest) returns (GetMeterConnectionResponse) {
    option (google.api.http) = {
      get: "/api/connections/{connection_id}/meters/{meter_connection_id}"
    };
  }

  // Remove a meter from a connection.
  rpc RemoveMeterFromConnection(RemoveMeterFromConnectionRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/connections/{connection_id}/meters/{meter_connection_id}"
    };
  }

  // Update a meter connection.
  rpc UpdateMeterConnection(UpdateMeterConnectionRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put: "/api/connections/{meter_connection.connection_id}/meters/{meter_connection.id}"
      body: "*"
    };
  }

  // List all meter connections.
  rpc ListMeterConnections(ListMeterConnectionsRequest) returns (ListMeterConnectionsResponse) {
    option (google.api.http) = {
      get: "/api/connections/{connection_id}/meters"
    };
  }

  // Upload CSV/XLS/XLSX file using a client streaming RPC
  rpc BulkUpload(stream BulkUploadRequest) returns (BulkUploadResponse) {
    option (google.api.http) = {
      post: "/api/connections/bulk-upload"
    };
  }

  // List report files from bulk uploads
  rpc ListReportFiles(ListReportFilesRequest) returns (ListReportFilesResponse) {
    option (google.api.http) = {
      get: "/api/connections/bulk-upload/reports"
    };
  }

  // Download a report file
  rpc DownloadReport(DownloadReportRequest) returns (stream DownloadReportResponse) {
    option (google.api.http) = {
      get: "/api/connections/bulk-upload/report/{filename}"
    };
  }
}

// Connection represents a connection configuration for a consumer.
message Connection {
  // Unique identifier for the connection.
  string id = 1;

  // ID of the consumer this connection belongs to.
  string consumer_id = 2;

  // Flag indicating if the connection is associated with an installation site.
  bool is_associated = 3;

  // Type of connection (e.g., water, gas, electricity).
  ConnectionType connection_type = 4;

  // Connection or service number.
  string connection_number = 5;

  // Category of the connection (e.g., domestic, commercial, industrial).
  ConnectionCategory category = 6;

  // Status of the connection (e.g., active, disconnected, disabled).
  ConnectionStatus status = 7;

  // Tenant ID (UUID) to which the connection belongs.
  string tenant_id = 8;

  // Timestamp when the connection was created.
  google.protobuf.Timestamp created_at = 9;

  // Timestamp when the connection was last updated.
  google.protobuf.Timestamp updated_at = 10;
}

// Request message for creating a connection.
message CreateConnectionRequest {
  Connection connection = 1;
}

// Response message for creating a connection.
message CreateConnectionResponse {
  string id = 1;
}

// Request message for getting a connection by ID.
message GetConnectionRequest {
  string id = 1;
}

// Response message for getting a connection.
message GetConnectionResponse {
  Connection connection = 1;
}

// Request message for updating a connection.
message UpdateConnectionRequest {
  Connection connection = 1;
}

// Request message for deleting a connection by ID.
message DeleteConnectionRequest {
  string connection_id = 1;
}

// Request message for listing connections.
message ListConnectionsRequest {
  // Optional tenant ID to filter connections.
  string tenant_id = 1;

  // Optional consumer ID to filter connections.
  string consumer_id = 2;

  // Maximum number of connections to return.
  uint32 limit = 3;

  // Offset for pagination.
  uint32 offset = 4;

  // Optional search string to filter connections by connection number or ID.
  string search = 5;

  // Optional status to filter connections.
  ConnectionStatus status = 6;

  // Optional connection type to filter connections.
  ConnectionType connection_type = 7;

  // Optional category to filter connections.
  ConnectionCategory category = 8;
}

// Response message for listing connections.
message ListConnectionsResponse {
  // Total number of connections matching the criteria.
  uint32 total_count = 1;

  // List of connections.
  repeated Connection connections = 2;
}

// MeterConnection represents a meter associated with a connection.
message MeterConnection {
  // Unique identifier for the MeterConnection.
  string id = 1;

  // Timestamp when the meter was installed.
  google.protobuf.Timestamp installed_at = 2;

  // Timestamp when the meter was removed (nullable).
  google.protobuf.Timestamp removed_at = 3;

  // Timestamp when the meter was created.
  google.protobuf.Timestamp created_at = 4;

  // Timestamp when the meter was updated.
  google.protobuf.Timestamp updated_at = 5;

  // ID of the connection this meter is associated with.
  string connection_id = 6;

  // Meter EUI (Extended Unique Identifier).
  string meter_eui = 7;

  // Meter serial number.
  string meter_serial_number = 8;

  // Status of the meter (e.g., active, inactive).
  MeterStatus meter_status = 9;

  // Last known reading from the meter.
  double last_known_reading = 10;

  // First billable reading from the meter.
  double first_billable_reading = 11;
}

// Request message for adding a meter to a connection.
message AddMeterToConnectionRequest {
  MeterConnection meter_connection = 1;
}

// Response message for adding a meter to a connection.
message AddMeterToConnectionResponse {
  string id = 1;
}

// Request message for getting a MeterConnection by ID.
message GetMeterConnectionRequest {
  string connection_id = 1;
  string meter_connection_id = 2;
}

// Response message for getting a MeterConnection.
message GetMeterConnectionResponse {
  MeterConnection meter_connection = 1;
}

// Request message for removing a meter from a connection.
message RemoveMeterFromConnectionRequest {
  string connection_id = 1;
  string meter_connection_id = 2;
}

// Request message for updating a MeterConnection.
message UpdateMeterConnectionRequest {
  MeterConnection meter_connection = 1;
}

// Request message for listing MeterConnections.
message ListMeterConnectionsRequest {
  // Connection ID to filter meter connections.
  string connection_id = 1;

  // Maximum number of meter connections to return.
  uint32 limit = 2;

  // Offset for pagination.
  uint32 offset = 3;

  // Optional status to filter meter connections.
  MeterStatus meter_status = 4;
}

// Response message for listing MeterConnections.
message ListMeterConnectionsResponse {
  // Total number of meter connections matching the criteria.
  uint32 total_count = 1;

  // List of meter connections.
  repeated MeterConnection meter_connections = 2;
}

// Bulk upload request (streaming like device)
message BulkUploadRequest {
  // CSV/XLS/XLSX file name
  string filename = 1;
  
  // File content chunk (for CSV) or entire file bytes (for XLS/XLSX)
  bytes content = 2;
  
  // File type: CSV, XLS, or XLSX
  FileType file_type = 4;
  
  // Is this the first chunk? (for chunked uploads)
  bool is_first_chunk = 5;
  
  // Is this the last chunk? (for chunked uploads)
  bool is_last_chunk = 6;
  
  // Total file size in bytes
  int64 total_size = 7;
  
  // Current chunk index
  int32 chunk_index = 8;
  
  // Total chunks
  int32 total_chunks = 9;            
  
  // Tenant ID (UUID) to which the connection belongs.
  string tenant_id = 10;
}

// Bulk upload response
message BulkUploadResponse {
  // Uploaded file path
  string filename = 1;
  
  // Status message
  string message = 2;
  
  // Number of connections created
  uint32 connections_created = 3;
  
  // Number of connections failed
  uint32 connections_failed = 4;
  
  // Number of consumers created (if applicable)
  uint32 consumers_created = 5;
  
  // Total records processed
  uint32 total_processed = 6;
  
  // Detailed report of each connection upload attempt
  repeated BulkUploadReportItem report = 7;
  
  // Report file path
  string report_filename = 8;
  
  // Upload status
  UploadStatus status = 9;
  
  // List of created connection IDs
  repeated string connection_ids = 10;
  
  // Processing time in milliseconds
  uint64 processing_time_ms = 11;
}

// Individual record upload result
message BulkUploadReportItem {
  // Record index (1-based)
  uint32 record_index = 1;
  
  // Connection number (if available)
  string connection_number = 2;
  
  // Consumer name (if available)
  string consumer_name = 3;
  
  // Status (Success/Failed)
  string status = 4;
  
  // Error message if failed
  string error_message = 5;
  
  // Created connection ID (if successful)
  string connection_id = 6;
  
  // Created consumer ID (if consumer was created)
  string consumer_id = 7;
  
  // Row number in original file
  uint32 row_number = 8;
  
  // Sheet name (for Excel files)
  string sheet_name = 9;
  
  // Warning messages (non-fatal issues)
  repeated string warnings = 10;
}

// Request to list report files
message ListReportFilesRequest {
  // Max number of reports to return
  uint32 limit = 1;
  
  // Offset for pagination
  uint32 offset = 2;
  
  // Search term
  string search = 3;
  
  // Start date filter
  google.protobuf.Timestamp start_date = 4;
  
  // End date filter
  google.protobuf.Timestamp end_date = 5;
  
  // File type filter
  FileType file_type = 6;
  
  // Tenant ID filter
  string tenant_id = 7;
}

// Response with list of report files
message ListReportFilesResponse {
  // Total number of reports
  uint32 total_count = 1;
  
  // List of report files
  repeated ReportFile reports = 2;
}

// Report file information
message ReportFile {
  // File name
  string filename = 1;
  
  // File path
  string path = 2;
  
  // Created at timestamp
  google.protobuf.Timestamp created_at = 3;
  
  // Success count
  uint32 success_count = 4;
  
  // Failure count
  uint32 failure_count = 5;
  
  // Connections created
  uint32 connections_created = 6;
  
  // Consumers created
  uint32 consumers_created = 7;
  
  // Upload status
  UploadStatus status = 8;
  
  // Original filename
  string original_filename = 9;
  
  // Total records
  uint32 total_records = 10;
  
  // File type
  FileType file_type = 11;
  
  // Tenant ID
  string tenant_id = 12;
  
  // Uploaded by user
  string uploaded_by = 13;
  
  // Processing time in milliseconds
  uint64 processing_time_ms = 14;
}

// Request to download a report file
message DownloadReportRequest {
  // File name
  string filename = 1;
  
}

// Response for downloading report files (streaming)
message DownloadReportResponse {
  // File content chunk
  bytes content = 1;
  
  // File name
  string filename = 2;
  
  // Content type
  string content_type = 3;
  
  // Total file size
  int64 total_size = 4;
}