syntax = "proto3";

package platform;

option go_package = "github.com/adarko-io/platform-api/go/v4/platform";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "platform/shared_enums.proto";
import "google/protobuf/struct.proto";

// ConnectionService provides API methods for managing connections for Consumers.
service ConnectionService {
  // Create a new connection for a consumer.
  rpc Create(CreateConnectionRequest) returns (CreateConnectionResponse) {
    option (google.api.http) = {
      post: "/api/connections"
      body: "*"
    };
  }

  // Get the connection details for a given Connection ID.
  rpc Get(GetConnectionRequest) returns (GetConnectionResponse) {
    option (google.api.http) = {
      get: "/api/connections/{id}"
    };
  }

  // Update an existing connection for a consumer.
  rpc Update(UpdateConnectionRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put: "/api/connections/{connection.id}"
      body: "*"
    };
  }

  // Delete a connection for a consumer.
  rpc Delete(DeleteConnectionRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/connections/{connection_id}"
    };
  }

  // List all connections
  rpc List(ListConnectionsRequest) returns (ListConnectionsResponse) {
    option (google.api.http) = {
      get: "/api/connections"
    };
  }


  // Add a meter to a connection.
  rpc AddMeterToConnection(AddMeterToConnectionRequest) returns (AddMeterToConnectionResponse) {
    option (google.api.http) = {
      post: "/api/connections/{meter.connection_id}/meters"
      body: "*"
    };
  }

  // Get a meter connection by ID.
  rpc GetMeterConnection(GetMeterRequest) returns (GetMeterResponse) {
    option (google.api.http) = {
      get: "/api/connections/{connection_id}/meters/{meter_id}"
    };
  }

  // Remove a meter from a connection.
  rpc RemoveMeterFromConnection(RemoveMeterFromConnectionRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/connections/{connection_id}/meters/{meter_id}"
    };
  }

  // Update a meter connection.
  rpc UpdateMeterConnection(UpdateMeterRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put: "/api/connections/{meter.connection_id}/meters/{meter.id}"
      body: "*"
    };
  }

  // List all meter connections.
  rpc ListMeterConnections(ListMeterRequest) returns (ListMeterResponse) {
    option (google.api.http) = {
      get: "/api/connections/{connection_id}/meters"
    };
  }

  // Upload CSV/XLS/XLSX file (handles records with HTTP streaming)
  rpc BulkUpload(BulkUploadRequest) returns (BulkUploadResponse) {
    option (google.api.http) = {
      post: "/api/connections/bulk-upload"
      body: "*"
    };
  }

  // List report files from bulk uploads
  rpc ListReportFiles(ListReportFilesRequest) returns (ListReportFilesResponse) {
    option (google.api.http) = {
      get: "/api/connections/bulk-upload/reports"
    };
  }

  // Download a report file (server streaming for large files)
  rpc DownloadReport(DownloadReportRequest) returns (stream DownloadReportResponse) {
    option (google.api.http) = {
      get: "/api/connections/bulk-upload/report/{filename}"
    };
  }
}

// Connection represents a connection configuration for a consumer.
message Connection {
  // Unique identifier for the connection.
  string id = 1;

  // ID of the consumer this connection belongs to.
  string consumer_id = 2;


  // Type of connection (e.g., water, gas, electricity).
  ConnectionType connection_type = 3;

  // Connection or service number.
  uint64 connection_number = 4;

  // Category of the connection (e.g., domestic, commercial, industrial).
  ConnectionCategory category = 5;

  // Status of the connection (e.g., active, disconnected, disabled).
  ConnectionStatus status = 6;

  // Tenant ID (UUID) to which the connection belongs.
  string tenant_id = 7;

  string door_plot_number = 8;

  string address = 9;

  string city = 10;

  string state = 11;

  string country = 12;

  string postal_code = 13;

  //Zone ID (UUID) to which the connection belongs. (Zone /Block/Locality within a city)
  string zone_id = 14;

   map<string, string> tags = 15;

  // Timestamp when the connection was created.
  google.protobuf.Timestamp created_at = 16;

  // Timestamp when the connection was last updated.
  google.protobuf.Timestamp updated_at = 17;

  // User who created the consumer
  string created_by = 18;

  // User who last updated the consumer
  string updated_by = 19;

  // Location information.
  Location location = 20;

  //meterConnections associated with this connection
  repeated Meter meter = 21;

  //reference number
  string reference_number = 22;

  // Timestamp when the connection was last updated.
  google.protobuf.Timestamp approved_at = 23;

  // User who created the consumer
  string approved_by = 24;

  // Additional notes about the consumer
  string note = 25;

  //Billing Profile ID for this connection
  string billing_profile_id = 26;

  //Name
  string name = 27;
}

// Request message for creating a connection.
message CreateConnectionRequest {
  Connection connection = 1;
}

// Response message for creating a connection.
message CreateConnectionResponse {
  string id = 1;
}

// Request message for getting a connection by ID.
message GetConnectionRequest {
  string id = 1;
}

// Response message for getting a connection.
message GetConnectionResponse {
  Connection connection = 1;
}

// Request message for updating a connection.
message UpdateConnectionRequest {
  Connection connection = 1;
}

// Request message for deleting a connection by ID.
message DeleteConnectionRequest {
  string connection_id = 1;
}

// Request message for listing connections.
message ListConnectionsRequest {
  // Optional tenant ID to filter connections.
  string tenant_id = 1;

  // Optional consumer ID to filter connections.
  string consumer_id = 2;

  // Maximum number of connections to return.
  uint32 limit = 3;

  // Offset for pagination.
  uint32 offset = 4;

  // Optional search string to filter connections by connection number or ID.
  string search = 5;

  // Optional status to filter connections.
  ConnectionStatus status = 6;

  // Optional connection type to filter connections.
  ConnectionType connection_type = 7;

  // Optional category to filter connections.
  ConnectionCategory category = 8;
}

// Response message for listing connections.
message ListConnectionsResponse {
  // Total number of connections matching the criteria.
  uint32 total_count = 1;

  // List of connections.
  repeated Connection connections = 2;
}

// MeterConnection represents a meter associated with a connection.
message Meter {
  // Unique identifier for the Meter.
  string id = 1;

  // Timestamp when the meter was installed.
  google.protobuf.Timestamp installed_at = 2;

  // Timestamp when the meter was removed (nullable).
  google.protobuf.Timestamp removed_at = 3;

  // Timestamp when the meter was created.
  google.protobuf.Timestamp created_at = 4;

  // Timestamp when the meter was updated.
  google.protobuf.Timestamp updated_at = 5;

  // ID of the connection this meter is associated with.
  string connection_id = 6;

  string inventory_id=7;

  // Status of the meter (e.g., active, inactive).
  MeterStatus meter_status = 8;

  // Last known reading from the meter.
  double last_known_reading = 9;

  // First billable reading from the meter.
  double first_billable_reading = 10;

   map<string, string> tags = 11;

   //Name
   string name=12;
}

// Request message for adding a meter to a connection.
message AddMeterToConnectionRequest {
  Meter meter= 1;
}

// Response message for adding a meter to a connection.
message AddMeterToConnectionResponse {
  string id = 1;
}

// Request message for getting a MeterConnection by ID.
message GetMeterRequest {
  string connection_id = 1;
  string meter_id = 2;
}

// Response message for getting a MeterConnection.
message GetMeterResponse {
  Meter meter = 1;
}

// Request message for removing a meter from a connection.
message RemoveMeterFromConnectionRequest {
  string connection_id = 1;
  string meter_id = 2;
}

// Request message for updating a MeterConnection.
message UpdateMeterRequest {
  Meter meter = 1;
}

// Request message for listing MeterConnections.
message ListMeterRequest {
  // Connection ID to filter meter connections.
  string connection_id = 1;

  // Maximum number of meter connections to return.
  uint32 limit = 2;

  // Offset for pagination.
  uint32 offset = 3;

  // Optional status to filter meter connections.
  MeterStatus meter_status = 4;
}

// Response message for listing MeterConnections.
message ListMeterResponse {
  // Total number of meter connections matching the criteria.
  uint32 total_count = 1;

  // List of meter connections.
  repeated Meter meter = 2;
}


// Bulk upload request for HTTP multipart form upload
message BulkUploadRequest {
  // CSV/XLS/XLSX file content as bytes
  bytes file_content = 1;
  
  // Original file name
  string filename = 2;
  
  // File type: CSV, XLS, or XLSX
  FileType file_type = 3;
  
  // Tenant ID (UUID) to which the connections belong
  string tenant_id = 4;
}

// Bulk upload response
message BulkUploadResponse {
  // Status message
  string message = 1;
  
  // Upload status (SUCCESS or FAILED)
  UploadStatus status = 2;
  
  // Number of connections created
  uint32 connections_created = 3;
  
  // Number of connections failed
  uint32 connections_failed = 4;
  
  // Total records processed
  uint32 total_processed = 5;
  
  // Detailed report of each record processed
  repeated BulkUploadReportItem report = 6;
  
  // Report file name (if generated)
  string report_filename = 7;
  
  // Processing time in milliseconds
  uint64 processing_time_ms = 8;
  
  // List of successfully created connection IDs
  repeated string connection_ids = 9;
}

// Individual record upload result
message BulkUploadReportItem {
  // Row number in file (1-based)
  uint32 row_number = 1;
  
  // Connection number from file
  string connection_number = 2;
  
  // Status: "success" or "failed"
  string status = 3;
  
  // Error message if failed
  string error_message = 4;
  
  // Created connection ID (if successful)
  string connection_id = 5;
  
  // Consumer name/ID (if available)
  string consumer_info = 6;
}

// Request to list report files
message ListReportFilesRequest {
  // Max number of reports to return
  uint32 limit = 1;
  
  // Offset for pagination
  uint32 offset = 2;
  
  // Search term
  string search = 3;
  
  // Start date filter
  google.protobuf.Timestamp start_date = 4;
  
  // End date filter
  google.protobuf.Timestamp end_date = 5;
  
  // File type filter
  FileType file_type = 6;
  
  // Tenant ID filter
  string tenant_id = 7;
  
  // Status filter
  UploadStatus status = 8;
}

// Response with list of report files
message ListReportFilesResponse {
  // Total number of reports
  uint32 total_count = 1;
  
  // List of report files
  repeated ReportFile reports = 2;
}

// Report file information
message ReportFile {
  // Report file name
  string filename = 1;
  
  // Created at timestamp
  google.protobuf.Timestamp created_at = 2;
  
  // Success count
  uint32 success_count = 3;
  
  // Failure count
  uint32 failure_count = 4;
  
  // Upload status
  UploadStatus status = 5;
  
  // Original uploaded filename
  string original_filename = 6;
  
  // File type
  FileType file_type = 7;
  
  // Tenant ID
  string tenant_id = 8;
  
  // Total records processed
  uint32 total_records = 9;
  
  // Processing time in milliseconds
  uint64 processing_time_ms = 10;
}

// Request to download a report file
message DownloadReportRequest {
  // File name
  string filename = 1;
}

// Response for downloading report files (streaming)
message DownloadReportResponse {
  oneof data {
    // First response contains metadata
    DownloadMetadata metadata = 1;
    // Subsequent responses contain file chunks
    bytes chunk = 2;
  }
}

// Download metadata sent in first response
message DownloadMetadata {
  // File name
  string filename = 1;
  
  // Content type (e.g., "text/csv", "application/vnd.ms-excel")
  string content_type = 2;
  
  // Total file size in bytes
  int64 total_size = 3;
}
