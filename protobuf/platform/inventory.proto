syntax = "proto3";

package platform;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "platform/shared_enums.proto";
import "google/protobuf/struct.proto";

option go_package = "github.com/adarko-io/platform-api/go/v4/platform";

// InventoryService manages device inventory, provisioning, and device-specific configurations.
// Devices must exist in inventory before they can be added to the device service.
service InventoryService {
  // Create a new device in inventory.
  rpc Create(CreateInventoryDeviceRequest) returns (CreateInventoryDeviceResponse) {
    option (google.api.http) = {
      post: "/api/inventory/devices",
      body: "*",
    };
  }

  // Get device from inventory by EUI.
  rpc Get(GetInventoryDeviceRequest) returns (GetInventoryDeviceResponse) {
    option (google.api.http) = {
      get: "/api/inventory/devices/{id}",
    };
  }

  // Update device in inventory.
  rpc Update(UpdateInventoryDeviceRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put:  "/api/inventory/devices/{inventory.id}",
      body: "*",
    };
  }

  // Delete device from inventory.
  rpc Delete(DeleteInventoryDeviceRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/inventory/devices/{id}",
    };
  }

  // List devices in inventory with filtering.
  rpc List(ListInventoryDevicesRequest) returns (ListInventoryDevicesResponse) {
    option (google.api.http) = {
      get: "/api/inventory/devices",
    };
  }

  // Update device status (onboarded/provisioned).
  rpc UpdateStatus(UpdateDeviceStatusRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      put:  "/api/inventory/devices/{id}/status",
      body: "*",
    };
  }

  // Bulk import devices to inventory.
  rpc BulkImport(BulkImportRequest) returns (BulkImportResponse) {
    option (google.api.http) = {
      post: "/api/inventory/devices/bulk-import",
      body: "*",
    };
  }
}

// InventoryDevice represents a device in the inventory with all necessary configuration.
message InventoryDevice {

  //id
  string id = 1;

  // EUI (EUI64) - Primary identifier.
  string eui = 2;

  // Serial number.
  string serial_number = 3;

  // Device name/model.
  string name = 4;

  // Device description.
  string description = 5;

  // Current inventory status.
  InventoryStatus status = 6;

  // DeviceProfile ID.
  string device_profile_id = 7;

  // Device type specific configuration JSON.
  google.protobuf.Value configuration = 8;

  // Device tags/labels.
  map<string, string> tags = 9;

  // Additional metadata.
  map<string, string> metadata = 10;

  // Batch/lot information.
  string batch_id = 11;
}

// NOTE: Enums moved to shared_enums.proto to avoid conflicts between services.


// Request/Response messages.
message CreateInventoryDeviceRequest {
  // Device to create.
  InventoryDevice inventory = 1;
}

message CreateInventoryDeviceResponse {
  // Inventory ID.
  string id = 1;
}

message GetInventoryDeviceRequest {
  // Inventory ID.
  string id = 1;
}

message GetInventoryDeviceResponse {
  // Device information.
  InventoryDevice inventory = 1;

  // Created at timestamp.
  google.protobuf.Timestamp created_at = 2;

  // Last update timestamp.
  google.protobuf.Timestamp updated_at = 3;
}

message UpdateInventoryDeviceRequest {
  // Device to update.
  InventoryDevice inventory = 1;
}

message DeleteInventoryDeviceRequest {
  // Inventory ID.
  string id = 1;
}

message ListInventoryDevicesRequest {
  // Maximum number of devices to return.
  uint32 limit = 1;

  // Offset for pagination.
  uint32 offset = 2;

  // Search query (name, description, etc.).
  string search = 3;

  // Filter by tags.
  map<string, string> tags = 4;
}

message InventoryDeviceListItem {

  //Inventory ID
  string id = 1;

  // Device EUI.
  string eui = 2;

  // Device name.
  string name = 3;

  // Serial number.
  string serial_number = 4;

  // Current status.
  InventoryStatus status = 5;

  // Device profile ID.
  string device_profile_id = 6;


  // Created at timestamp.
  google.protobuf.Timestamp created_at = 7;

  // Last update timestamp.
  google.protobuf.Timestamp updated_at = 8;
}

message ListInventoryDevicesResponse {
  // Total count.
  uint32 total_count = 1;

  // Device list.
  repeated InventoryDeviceListItem devices = 2;
}

message UpdateDeviceStatusRequest {
  //  Inventory ID.
  string id = 1;

  // New status.
  InventoryStatus status = 2;

  // Status update reason/notes.
  string notes = 3;
}

message BulkImportRequest {
  // Devices to import.
  repeated InventoryDevice devices = 1;

  // Skip devices that already exist.
  bool skip_existing = 2;
}

message BulkImportResponse {
  // Number of devices successfully imported.
  uint32 imported_count = 1;

  // Number of devices skipped.
  uint32 skipped_count = 2;

  // Number of devices failed.
  uint32 failed_count = 3;

  // Import errors.
  repeated ImportError errors = 4;
}

message ImportError {
  //  Inventory ID that failed.
  string id = 1;

  // Error message.
  string error = 2;
}
